apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: database-backup-config
  namespace: database-backup
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: onepassword
    kind: ClusterSecretStore
  target:
    name: database-backup-config-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        config.yaml: |
          # Database Backup System Configuration
          # Generated from External Secret Operator

          # PostgreSQL Database Configuration
          pgsql:
          - id: immich
            host: immich.pgsql.nullservers.com
            port: 5432
            database: immich
            username: {{ .immich_username }}
            password: {{ .immich_password }}
          - id: authentik
            host: pgsql.nullservers.com
            port: 5432
            database: authentik
            username: {{ .authentik_username }}
            password: {{ .authentik_password }}
          - id: recipes
            host: pgsql.nullservers.com
            port: 5432
            database: recipes
            username: {{ .recipes_username }}
            password: {{ .recipes_password }}
          - id: nextcloud
            host: pgsql.nullservers.com
            port: 5432
            database: nextcloud
            username: {{ .nextcloud_username }}
            password: {{ .nextcloud_password }}

          # MongoDB Database Configuration (uncomment and configure as needed)
          mongodb:
           - id: tibia_stats
             host: mongodb.nullservers.com
             port: 27017
             database: tibia-statistics
             uri: mongodb://{{ .mongodb_username }}:{{ .mongodb_password }}@mongodb.nullservers.com:27017/tibia-statistics

          # FTP Configuration (optional)
          ftp:
            host: storage.nullservers.com
            port: 21
            username: {{ .ftp_username }}
            password: {{ .ftp_password }}
            remote_dir: /backup/db-backups/
            ssl: false

          # Telegram Configuration
          telegram:
            bot_token: {{ .telegram_bot_token }}
            chat_id: {{ .telegram_chat_id }}
            enabled: true

          # Backup Configuration
          backup:
            directory: /app/backups
            retention_days: 7
            compression: true
            log_level: INFO
            verbose: false
  data:
  # PostgreSQL Configuration -- Immich
  - secretKey: immich_username
    remoteRef:
      key: immich-db-credentials
      property: username
  - secretKey: immich_password
    remoteRef:
      key: immich-db-credentials
      property: new-password
  # PostgreSQL Configuration -- Authentik
  - secretKey: authentik_username
    remoteRef:
      key: authentik-credentials
      property: username
  - secretKey: authentik_password
    remoteRef:
      key: authentik-credentials
      property: password-new
  # Recipes PostgreSQL Configuration
  - secretKey: recipes_username
    remoteRef:
      key: recipes-db-pwd
      property: username
  - secretKey: recipes_password
    remoteRef:
      key: recipes-db-pwd
      property: password-new
  # Nextcloud PostgreSQL Configuration
  - secretKey: nextcloud_username
    remoteRef:
      key: nextcloud-credentials
      property: dbUsername
  - secretKey: nextcloud_password
    remoteRef:
      key: nextcloud-credentials
      property: dbPasswordNew

  # MongoDB Configuration (uncomment as needed)
  - secretKey: mongodb_username
    remoteRef:
      key: mongodb-backup-credentials
      property: username
  - secretKey: mongodb_password
    remoteRef:
      key: mongodb-backup-credentials
      property: password

  # FTP Configuration (uncomment as needed)
  - secretKey: ftp_username
    remoteRef:
      key: ftp-server-password
      property: username
  - secretKey: ftp_password
    remoteRef:
      key: ftp-server-password
      property: password

  # Telegram Configuration
  - secretKey: telegram_bot_token
    remoteRef:
      key: telegram-bot
      property: password
  - secretKey: telegram_chat_id
    remoteRef:
      key: telegram-bot
      property: chat-id
